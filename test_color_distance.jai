#load "color_space.jai";
#load "color_distance.jai";

#import "Basic";

test_ciede2000 :: () {
    Test_Case :: struct {
        a, b: CIELAB;
        expected: float64;
    }

    EPSILON :: 0.00005;

    // These test cases are taken from the paper:
    // The CIEDE2000 Color-Difference Formula: Implementation Notes, Supplementary Test Data, and Mathematical Observations,
    // https://hajim.rochester.edu/ece/sites/gsharma/ciede2000/
    TC :: Test_Case.[
                     .{a = .{l = 50.0000, a = 2.6772, b = -79.7751},
                       b = .{l = 50.0000, a = 0.0000, b = -82.7485},
                       expected = 2.0425},
                     .{a = .{l = 50.0000, a = 3.1571, b = -77.2803},
                       b = .{l = 50.0000, a = 0.0000, b = -82.7485},
                       expected = 2.8615},
                     .{a = .{l = 50.0000, a = 2.8361, b = -74.0200},
                       b = .{l = 50.0000, a = 0.0000, b = -82.7485},
                       expected = 3.4412},
                     .{a = .{l = 50.0000, a = -1.3802, b = -84.2814},
                       b = .{l = 50.0000, a = 0.0000, b = -82.7485},
                       expected = 1.0000},
                     .{a = .{l = 50.0000, a = -1.1848, b = -84.8006},
                       b = .{l = 50.0000, a = 0.0000, b = -82.7485},
                       expected = 1.0000},
                     .{a = .{l = 50.0000, a = -0.9009, b = -85.5211},
                       b = .{l = 50.0000, a = 0.0000, b = -82.7485},
                       expected = 1.0000},
                     .{a = .{l = 50.0000, a = 0.0000, b = 0.0000},
                       b = .{l = 50.0000, a = -1.0000, b = 2.0000},
                       expected = 2.3669},
                     .{a = .{l = 50.0000, a = -1.0000, b = 2.0000},
                       b = .{l = 50.0000, a = 0.0000, b = 0.0000},
                       expected = 2.3669},
                     .{a = .{l = 50.0000, a = 2.4900, b = -0.0010},
                       b = .{l = 50.0000, a = -2.4900, b = 0.0009},
                       expected = 7.1792},
                     .{a = .{l = 50.0000, a = 2.4900, b = -0.0010},
                       b = .{l = 50.0000, a = -2.4900, b = 0.0010},
                       expected = 7.1792},
                     .{a = .{l = 50.0000, a = 2.4900, b = -0.0010},
                       b = .{l = 50.0000, a = -2.4900, b = 0.0011},
                       expected = 7.2195},
                     .{a = .{l = 50.0000, a = 2.4900, b = -0.0010},
                       b = .{l = 50.0000, a = -2.4900, b = 0.0012},
                       expected = 7.2195},
                     .{a = .{l = 50.0000, a = -0.0010, b = 2.4900},
                       b = .{l = 50.0000, a = 0.0009, b = -2.4900},
                       expected = 4.8045},
                     .{a = .{l = 50.0000, a = -0.0010, b = 2.4900},
                       b = .{l = 50.0000, a = 0.0010, b = -2.4900},
                       expected = 4.8045},
                     .{a = .{l = 50.0000, a = -0.0010, b = 2.4900},
                       b = .{l = 50.0000, a = 0.0011, b = -2.4900},
                       expected = 4.7461},
                     .{a = .{l = 50.0000, a = 2.5000, b = 0.0000},
                       b = .{l = 50.0000, a = 0.0000, b = -2.5000},
                       expected = 4.3065},
                     .{a = .{l = 50.0000, a = 2.5000, b = 0.0000},
                       b = .{l = 73.0000, a = 25.0000, b = -18.0000},
                       expected = 27.1492},
                     .{a = .{l = 50.0000, a = 2.5000, b = 0.0000},
                       b = .{l = 61.0000, a = -5.0000, b = 29.0000},
                       expected = 22.8977},
                     .{a = .{l = 50.0000, a = 2.5000, b = 0.0000},
                       b = .{l = 56.0000, a = -27.0000, b = -3.0000},
                       expected = 31.9030},
                     .{a = .{l = 50.0000, a = 2.5000, b = 0.0000},
                       b = .{l = 58.0000, a = 24.0000, b = 15.0000},
                       expected = 19.4535},
                     .{a = .{l = 50.0000, a = 2.5000, b = 0.0000},
                       b = .{l = 50.0000, a = 3.1736, b = 0.5854},
                       expected = 1.0000},
                     .{a = .{l = 50.0000, a = 2.5000, b = 0.0000},
                       b = .{l = 50.0000, a = 3.2972, b = 0.0000},
                       expected = 1.0000},
                     .{a = .{l = 50.0000, a = 2.5000, b = 0.0000},
                       b = .{l = 50.0000, a = 1.8634, b = 0.5757},
                       expected = 1.0000},
                     .{a = .{l = 50.0000, a = 2.5000, b = 0.0000},
                       b = .{l = 50.0000, a = 3.2592, b = 0.3350},
                       expected = 1.0000},
                     .{a = .{l = 60.2574, a = -34.0099, b = 36.2677},
                       b = .{l = 60.4626, a = -34.1751, b = 39.4387},
                       expected = 1.2644},
                     .{a = .{l = 63.0109, a = -31.0961, b = -5.8663},
                       b = .{l = 62.8187, a = -29.7946, b = -4.0864},
                       expected = 1.2630},
                     .{a = .{l = 61.2901, a = 3.7196, b = -5.3901},
                       b = .{l = 61.4292, a = 2.2480, b = -4.9620},
                       expected = 1.8731},
                     .{a = .{l = 35.0831, a = -44.1164, b = 3.7933},
                       b = .{l = 35.0232, a = -40.0716, b = 1.5901},
                       expected = 1.8645},
                     .{a = .{l = 22.7233, a = 20.0904, b = -46.6940},
                       b = .{l = 23.0331, a = 14.9730, b = -42.5619},
                       expected = 2.0373},
                     .{a = .{l = 36.4612, a = 47.8580, b = 18.3852},
                       b = .{l = 36.2715, a = 50.5065, b = 21.2231},
                       expected = 1.4146},
                     .{a = .{l = 90.8027, a = -2.0831, b = 1.4410},
                       b = .{l = 91.1528, a = -1.6435, b = 0.0447},
                       expected = 1.4441},
                     .{a = .{l = 90.9257, a = -0.5406, b = -0.9208},
                       b = .{l = 88.6381, a = -0.8985, b = -0.7239},
                       expected = 1.5381},
                     .{a = .{l = 6.7747, a = -0.2908, b = -2.4247},
                       b = .{l = 5.8714, a = -0.0985, b = -2.2286},
                       expected = 0.6377},
                     .{a = .{l = 2.0776, a = 0.0795, b = -1.1350},
                       b = .{l = 0.9033, a = -0.0636, b = -0.5514},
                       expected = 0.9082}];
    failures := 0;
    for tc: TC {
        actual := distance_CIEDE2000(tc.a, tc.b);

        delta := abs(actual - tc.expected);

        if delta > EPSILON {
            failures += 1;
            print("FAIL expected %, got %, |delta| %\n", tc.expected, actual, delta);
        }
    }

    if failures == 0 {
        print("PASS distance_CIEDE2000 tests (% cases)\n", TC.count);
    } else {
        print("FAIL distance_CIEDE2000 tests: % failures\n", failures);
        exit(1);
    }
}

main :: () {
    test_ciede2000();
}
